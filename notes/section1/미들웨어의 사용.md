## 4. 미들웨어

**4-1. body-parser**

- 서드파티 미들웨어 = official 하지 않은 미들웨어
- https://expressjs.com/en/resources/middleware/body-parser.html

```bash
npm install body-parser --save
```

```jsx

app.post('/create_process', function (req, res) {
  /* var body = '';
  req.on('data', function (data) {
    body = body + data;
  });
  req.on('end', function () {
    var post = qs.parse(body);
    var title = post.title;
    var description = post.description;
    fs.writeFile(`data/${title}`, description, 'utf8', function (err) {
      res.writeHead(302, { Location: `/?id=${title}` });
      res.end();
    });
  }); */
  
  var post = req.body; // body-parser 사용
  var title = post.title;
  var description = post.description;
  fs.writeFile(`data/${title}`, description, 'utf8', function (err) {
    res.writeHead(302, { Location: `/?id=${title}` });
    res.end();
  })
 
});
```

- 내부적으로 body-parser가 동작하여 req 객채의 body를 직접 받아옴
- ⚠️ error log : update parameter 오류
    
    `update` 버튼 누르면[http://localhost:3000/update/test](http://localhost:3000/update?id=test)가 아니라 http://localhost:3000/update?id=test 로 이동함 
    
    ```jsx
    app.get('/page/:pageId', function (req, res) {
      fs.readdir('./data', function (error, filelist) {
        const filteredId = path.parse(req.params.pageId).base;
        fs.readFile(`data/${filteredId}`, 'utf8', function (err, description) {
          if (err) return res.status(404).send('File not found');
    
          const title = req.params.pageId;
          const sanitizedTitle = sanitizeHtml(title);
          const sanitizedDescription = sanitizeHtml(description, { allowedTags:['h1'] });
          const list = template.list(filelist);
    
          const html = template.HTML(
            sanitizedTitle,
            list,
            `<h2>${sanitizedTitle}</h2>${sanitizedDescription}`,
            `
            <a href="/create">create</a>
            
            <!-- 이전 코드 (쿼리 파라미터 사용) -->
            <!-- <a href="/update?id=${sanitizedTitle}">update</a> -->
    
            <!-- 수정된 코드 (path parameter 사용) -->
            <a href="/update/${encodeURIComponent(sanitizedTitle)}">update</a>
    
            <form action="/delete_process" method="post">
              <input type="hidden" name="id" value="${sanitizedTitle}">
              <input type="submit" value="delete">
            </form>
            `
          );
    
          res.send(html);
        });
      });
    });
    
    ```
    
    ### 이후 HTML 캐시 초기화
    
    - 브라우저가 이전 HTML을 캐싱하고 있어서, 클릭해도 여전히 예전 링크(`/update?id=test`)로 보이는 경우가 많습니다.
    - **해결:** 브라우저에서 강력 새로고침
        - Windows: `Ctrl + Shift + R`
        - Mac: `Cmd + Shift + R`
    - 또는 개발자 도구 → Network 탭 → "Disable cache" 체크 후 새로고침
    

```jsx
app.post('/update_process', function (req, res) {

  var post = req.body; // body-parser 사용
  var id = post.id;
  var title = post.title;
  var description = post.description;
  fs.rename(`data/${id}`, `data/${title}`, function (error) {
    fs.writeFile(`data/${title}`, description, 'utf8', function (err) {
      res.writeHead(302, { Location: `/?id=${encodeURIComponent(title)}` });
      res.end();
    })
  });
});
```

```jsx
app.post('/delete_process', function (req, res) {
  var post = req.body; // body-parser 사용
  var id = post.id;
  var filteredId = path.parse(id).base;
  fs.unlink(`data/${filteredId}`, function (error) {
    /* res.writeHead(302, {Location: `/`});
    res.end(); */
    res.redirect('/'); // express의 res.redirect 사용 (위의 주석 처리된 부분과 동일한 기능 수행)
  })
});

app.listen(port, function () {
  console.log(`Example app listening on port ${port}`)
});

```

**4-2. compression**

```bash
npm install compression --save
```

- Express.js용 미들웨어
- https://expressjs.com/en/resources/middleware/compression.html
- 모든 응답(res.send, res.json 등)을 자동으로 압축
- 브라우저가 `Accept-Encoding: gzip, deflate, br` 헤더를 보내면, 압축된 데이터를 전송

```jsx
app.use(compression());
// 모든 요청에 대해 압축 적
```

- HTML, CSS, JS, JSON 등 텍스트 기반 파일
- 이미 압축된 이미지, 동영상, PDF 등에는 비효율적


**정리**

```
[사용자] 
   |
   | POST /create_process (폼 제출)
   v
[서버] → body-parser / express.urlencoded()로 body 수신
       → req.body.title, req.body.description 접근 가능
       → fs.writeFile('data/title', description)
       → res.redirect('/?id=title')
   |
   v
[브라우저] → /?id=title 페이지 로딩

---------------------------
[사용자] 
   |
   | GET /page/:pageId
   v
[서버] → fs.readdir + fs.readFile('data/pageId')
       → template.HTML(내용 표시)
       → compression 미들웨어로 HTML 응답 압축
   |
   v
[브라우저] → 압축된 HTML 표시

---------------------------
[사용자] 
   |
   | GET /update/:pageId
   v
[서버] → fs.readdir + fs.readFile('data/pageId')
       → template.HTML(수정 폼 표시)
       → compression 미들웨어로 응답 압축
   |
   v
[브라우저] → 압축된 HTML 표시

---------------------------
[사용자] 
   |
   | POST /update_process
   v
[서버] → body-parser / express.urlencoded()로 body 수신
       → fs.rename('oldTitle', 'newTitle')
       → fs.writeFile('newTitle', description)
       → res.redirect('/?id=newTitle')
       → compression 미들웨어로 응답 압축
   |
   v
[브라우저] → /?id=newTitle 페이지 로딩

```

